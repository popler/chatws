<!doctype html>
<html lang="pl" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <title>VLS Chat ‚Äì Panel admina</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 16px; font: 14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .log { max-height: 40vh; overflow:auto; background: var(--bs-tertiary-bg); border:1px solid var(--bs-border-color); border-radius:10px; padding:8px; font-family: ui-monospace,SFMono-Regular,Menlo,monospace; font-size:.9rem; }
    .muted { color: var(--bs-secondary-color); }
    .kbd { border:1px solid var(--bs-border-color); border-bottom-width:2px; border-radius:6px; padding:0 .35rem; font-size:.85em; background:var(--bs-tertiary-bg); }
    .btn-xxs{ --bs-btn-padding-y:.15rem; --bs-btn-padding-x:.35rem; --bs-btn-font-size:.7rem; }
    .form-hint{ font-size:.85em; color: var(--bs-secondary-color); }
    .badge-dot{ display:inline-block; width:.5rem; height:.5rem; border-radius:50%; background:#31c24b; box-shadow:0 0 0 2px var(--bs-body-bg) inset; vertical-align:middle; margin-right:.35rem; }
    .table-fixed tbody{ display:block; max-height:38vh; overflow:auto; }
    .table-fixed thead, .table-fixed tbody tr{ display:table; width:100%; table-layout:fixed; }
    .table-sm th, .table-sm td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .room-row.active{ background:var(--bs-tertiary-bg); }

    /* W trybie autologowania tokenem schowaj pola has≈Ça i przycisk Po≈ÇƒÖcz do czasu zako≈Ñczenia */
    .chat-autologin #pass,
    .chat-autologin #togglePass,
    .chat-autologin #connect { display:none !important; }
  </style>

</head>
<body>
<div class="container" style="max-width:1100px">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Panel administracyjny</h3>
    <div class="d-flex gap-2">
      <button id="btnLight" class="btn btn-outline-secondary btn-sm">‚òÄÔ∏è Jasny</button>
      <button id="btnDark"  class="btn btn-outline-secondary btn-sm">üåô Ciemny</button>
    </div>
  </div>

  <!-- Po≈ÇƒÖczenie -->
  <div class="card mb-3">
    <div class="card-header">Po≈ÇƒÖczenie</div>
    <div class="card-body row g-2">
      <div class="col-md-3">
        <label class="form-label">Pok√≥j</label>
        <input id="room" class="form-control" placeholder="np. demo">
      </div>
      <div class="col-md-3">
        <label class="form-label">Nick admina</label>
        <input id="nick" class="form-control" placeholder="np. piotrg">
      </div>
      <div class="col-md-3">
        <label class="form-label">Has≈Ço</label>
        <div class="input-group">
          <input id="pass" class="form-control" type="password" placeholder="Has≈Ço admina">
          <button id="togglePass" class="btn btn-outline-secondary" type="button">üëÅ</button>
        </div>
        <div class="form-hint">Adminy i hash hase≈Ç sƒÖ w <code>admins.json</code>.</div>
      </div>
      <div class="col-md-3 d-grid align-self-end">
        <button id="connect" class="btn btn-primary">Po≈ÇƒÖcz</button>
      </div>
      <div class="col-12 mt-2">
        <span id="status" class="muted">‚Äî</span>
        <span class="ms-3"><span class="badge-dot" id="dot" style="background:#aaa"></span><span id="presence">offline</span></span>
      </div>
    </div>
  </div>

  <div id="controls" style="display:none">
    <div class="row">
      <!-- LEWA: Pokoje + U≈ºytkownicy -->
      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Aktywne pokoje</span>
            <div class="d-flex align-items-center gap-2">
              <button id="refreshRooms" class="btn btn-sm btn-outline-secondary">Od≈õwie≈º</button>
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="autoRooms">
                <label class="form-check-label" for="autoRooms">Auto 15s</label>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive table-fixed">
              <table class="table table-sm align-middle">
                <thead>
                  <tr><th style="width:40%">Pok√≥j</th><th style="width:20%">Online</th><th style="width:20%">Slow</th><th style="width:20%">Akcje</th></tr>
                </thead>
                <tbody id="roomsTbody"></tbody>
              </table>
            </div>
            <div id="roomsInfo" class="form-hint mt-2"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>U≈ºytkownicy w pokoju: <strong id="usersRoom">‚Äî</strong></span>
            <div class="d-flex gap-2">
              <input id="userSearch" class="form-control form-control-sm" placeholder="Szukaj (nick/id)" style="width:220px">
              <button id="refreshUsers" class="btn btn-sm btn-outline-secondary">Od≈õwie≈º</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive table-fixed">
              <table class="table table-sm align-middle">
                <thead>
                  <tr><th style="width:40%">Nick</th><th style="width:20%">ID</th><th style="width:20%">Msg</th><th style="width:20%">Akcje</th></tr>
                </thead>
                <tbody id="usersTbody"></tbody>
              </table>
            </div>
            <div id="usersInfo" class="form-hint mt-2"></div>
          </div>
        </div>
      </div>

      <!-- PRAWA: Og≈Çoszenia / Slow / Moderacja / Logi -->
      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header">Og≈Çoszenie / Slow / Clear</div>
          <div class="card-body row g-2">
            <div class="col-md-7">
              <label class="form-label">PIN (og≈Çoszenie)</label>
              <input id="announceText" class="form-control" placeholder="Tekst og≈Çoszenia (PIN)">
            </div>
            <div class="col-md-2 d-grid align-self-end">
              <button id="announceBtn" class="btn btn-outline-secondary">Wy≈õlij PIN</button>
            </div>
            <div class="col-md-3">
              <label class="form-label">Slow-mode</label>
              <div class="input-group">
                <select id="slowSelect" class="form-select">
                  <option value="off">off</option>
                  <option value="2s">2s</option>
                  <option value="5s">5s</option>
                  <option value="10s">10s</option>
                  <option value="30s">30s</option>
                </select>
                <button id="slowBtn" class="btn btn-outline-secondary">Ustaw</button>
              </div>
            </div>
            <div class="col-12 d-grid mt-2">
              <button id="clearBtn" class="btn btn-outline-danger">Wyczy≈õƒá czat</button>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Moderacja</span>
            <span class="form-hint">Tip: kliknij <span class="kbd">Kopiuj</span> przy ID by wkleiƒá ni≈ºej</span>
          </div>
          <div class="card-body row g-2">
            <div class="col-md-6">
              <label class="form-label">userId</label>
              <div class="input-group">
                <input id="userId" class="form-control" placeholder="userId">
                <button id="copyUserId" class="btn btn-outline-secondary btn-xxs" type="button">Kopiuj</button>
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Minuty</label>
              <input id="minutes" class="form-control" type="number" value="5" min="1">
            </div>
            <div class="col-md-4 d-grid align-self-end">
              <button id="timeoutBtn" class="btn btn-outline-warning">Timeout (min)</button>
            </div>

            <div class="col-md-6">
              <label class="form-label">messageId</label>
              <div class="input-group">
                <input id="msgId" class="form-control" placeholder="messageId">
                <button id="copyMsgId" class="btn btn-outline-secondary btn-xxs" type="button">Kopiuj</button>
              </div>
            </div>
            <div class="col-md-2 d-grid align-self-end">
              <button id="banBtn"   class="btn btn-outline-danger">Ban</button>
            </div>
            <div class="col-md-2 d-grid align-self-end">
              <button id="purgeBtn" class="btn btn-outline-danger">Purge</button>
            </div>
            <div class="col-md-2 d-grid align-self-end">
              <button id="deleteBtn" class="btn btn-outline-danger">Usu≈Ñ</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Audyt akcji admina (REST)</span>
                <div class="d-flex align-items-center gap-2">
                  <button id="downloadCsv" class="btn btn-sm btn-outline-primary">Pobierz CSV historii</button>
                  <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="autoAudit">
                    <label class="form-check-label" for="autoAudit">Auto 10s</label>
                  </div>
                  <button id="refreshAudit" class="btn btn-sm btn-outline-secondary">Od≈õwie≈º</button>
                </div>
              </div>
              <div class="card-body">
                <pre class="log" id="auditLog">(pusto)</pre>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Zdarzenia WS (ostatnie)</span>
                <button id="clearWsLog" class="btn btn-sm btn-outline-secondary">Wyczy≈õƒá</button>
              </div>
              <div class="card-body">
                <pre class="log" id="wsLog">(pusto)</pre>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /col-lg-6 -->
    </div><!-- /row -->
  </div><!-- /controls -->
</div>

<script>
/* ===== CONFIG ===== */
const ORIGIN   = 'https://relay.popler.tv';
const API_JOIN = ORIGIN + '/chat/api/join';
const API_AUDIT= ORIGIN + '/chat/api/admin/audit';
const API_ROOMS= ORIGIN + '/chat/api/rooms';
const API_USERS= (room)=> ORIGIN + '/chat/api/rooms/' + encodeURIComponent(room) + '/users';
const API_LOGCSV = ORIGIN + '/chat/api/admin/log.csv';
const WS_URL   = ORIGIN.replace(/^http/,'ws') + '/chat/ws';

/* === Helpery i elementy ‚Äì MUSZƒÑ byƒá zdefiniowane PRZED autologowaniem === */
const $ = (id)=>document.getElementById(id);
const statusEl   = $('status');
const presenceEl = $('presence');
const dotEl      = $('dot');
const wsLogEl    = $('wsLog');

function showStatus(s){ if(statusEl) statusEl.textContent = s; }
function setPresence(n, online){
  if (presenceEl) presenceEl.textContent = online ? `${n} online` : 'offline';
  if (dotEl) dotEl.style.background = online ? '#31c24b' : '#aaa';
}
function appendWsLog(line){
  if (!wsLogEl) return;
  const now = new Date().toISOString().replace('T',' ').slice(0,19);
  const txt = `[${now}] ${line}\n`;
  wsLogEl.textContent = (wsLogEl.textContent || '') + txt;
  wsLogEl.scrollTop = wsLogEl.scrollHeight;
}
function copyToClipboard(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }
function fmtTs(ts){ if(!ts) return '‚Äî'; try{ const d=new Date(ts); return d.toLocaleString(); }catch{ return '‚Äî'; } }

/* Theme toggle */
$('btnLight').onclick = ()=>document.documentElement.setAttribute('data-bs-theme','light');
$('btnDark').onclick  = ()=>document.documentElement.setAttribute('data-bs-theme','dark');

/* Pamiƒôtaj ostatni room/nick (nie has≈Ço) */
(function restoreSaved(){
  const qs=new URLSearchParams(location.search);
  if ($('room')) $('room').value = qs.get('room') || localStorage.getItem('adm_room') || 'demo';
  if ($('nick')) $('nick').value = qs.get('nick') || localStorage.getItem('adm_nick') || '';
})();
function saveCreds(){
  if ($('room')) localStorage.setItem('adm_room',$('room').value.trim());
  if ($('nick')) localStorage.setItem('adm_nick',$('nick').value.trim());
}

/* Poka≈º/ukryj has≈Ço + kopiuj */
$('togglePass').onclick = ()=>{ const inp=$('pass'); if(!inp) return; inp.type = (inp.type==='password') ? 'text' : 'password'; };
$('copyUserId').onclick = ()=>{ const v=$('userId').value.trim(); if(v) copyToClipboard(v); };
$('copyMsgId').onclick  = ()=>{ const v=$('msgId').value.trim(); if(v) copyToClipboard(v); };

/* ===== Panel SSO via JWT (token w URL) ===== */
function b64urlToJson(segment){
  try{
    segment = segment.replace(/-/g,'+').replace(/_/g,'/');
    const pad = segment.length % 4; if (pad) segment += '='.repeat(4-pad);
    return JSON.parse(atob(segment));
  }catch{ return null; }
}
function decodeJwtNoVerify(jwt){
  if(!jwt) return null;
  const parts = jwt.split('.');
  if(parts.length !== 3) return null;
  const header = b64urlToJson(parts[0]);
  const claims = b64urlToJson(parts[1]);
  return { header, claims };
}

// Bezpieczny stub (gasi "onWsMessage is not defined")
window.onWsMessage = window.onWsMessage || function (payload) {
  try { console.debug('[chat:onWsMessage]', typeof payload === 'string' ? JSON.parse(payload) : payload); }
  catch { console.debug('[chat:onWsMessage:raw]', payload); }
};

let token=null, ws=null, room=null;

// 1) Auto-connect z weryfikacjƒÖ tokena
(function(){
  try{
    const qs = new URLSearchParams(location.search);
    const t  = (qs.get('token')||'').trim();
    const r  = (qs.get('room')||'').trim();
    if (!t || !r) return; // brak tokenu ‚Üí standardowy tryb (formularz has≈Ça)

    token = t; room = r;
    if ($('room')) $('room').value = room;
    if ($('nick') && !$('nick').value) $('nick').value = 'Admin';

    // ukryj pola has≈Ça i przycisk, poka≈º stan
    document.documentElement.classList.add('chat-autologin');
    showStatus('Token z panelu ‚Äì weryfikacja‚Ä¶');

    // 1a) weryfikacja tokenu (HS256) po backendzie
    fetch('/chat/api/verify.php?token=' + encodeURIComponent(token), {
      method: 'GET', headers: { 'Accept': 'application/json' }
    })
    .then(res => { if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); })
    .then(j => {
      if (!j || !j.ok) throw new Error(j && j.error || 'verify_failed');

      // token mo≈ºe zawieraƒá w≈Ça≈õciwƒÖ nazwƒô pokoju ‚Äì u≈ºyj jej
      if (j.room && j.room !== room) {
        room = j.room;
        if ($('room')) $('room').value = room;
      }

      // 1b) ≈ÇƒÖczymy po WS; je≈õli backend wymaga te≈º &room= ‚Äì dodaj
      showStatus('Token OK ‚Äì ≈ÇƒÖczenie do WS‚Ä¶');
      try {
        ws = new WebSocket(WS_URL + '?token=' + encodeURIComponent(token));
      } catch (e) {
        showStatus('WS init error: ' + e.message);
        document.documentElement.classList.remove('chat-autologin');
        return;
      }

      ws.onopen = () => {
        showStatus('WS po≈ÇƒÖczone (admin).');
        if ($('controls')) $('controls').style.display='block';
        setPresence(1,true);
        appendWsLog('WS OPEN (token)');
      };

      ws.onclose = () => {
        showStatus('WS roz≈ÇƒÖczone.');
        setPresence(0,false);
        appendWsLog('WS CLOSE');
      };

      ws.onerror = (e) => {
        showStatus('WS b≈ÇƒÖd.');
        appendWsLog('WS ERROR');
      };

      ws.onmessage = (ev) => {
        appendWsLog('WS MSG: ' + ev.data.slice(0,200));
        try { window.onWsMessage && window.onWsMessage(ev.data); } catch(_) {}
      };

    })
    .catch(err => {
      console.warn('[jwt-autologin] fallback do formularza:', err && err.message);
      showStatus('Nie uda≈Ço siƒô zweryfikowaƒá tokenu. Podaj has≈Ço admina i Po≈ÇƒÖcz.');
      document.documentElement.classList.remove('chat-autologin');
    });

  }catch(e){
    console.warn('[jwt-autologin] wyjƒÖtek IIFE:', e);
    document.documentElement.classList.remove('chat-autologin');
  }
})();

/* Po≈ÇƒÖcz (join + WS) ‚Äì tryb has≈Ço */
$('connect').onclick = async ()=>{
  room = $('room').value.trim();
  const displayName = $('nick').value.trim();
  const password = $('pass').value;

  if(!room || !displayName || !password){ showStatus('Uzupe≈Çnij pok√≥j, nick i has≈Ço.'); return; }

  showStatus('≈ÅƒÖczenie (REST)‚Ä¶');
  let j;
  try{
    const r = await fetch(API_JOIN, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room, displayName, password }) });
    if (!r.ok) { showStatus('B≈ÇƒÖd join: HTTP '+r.status); return; }
    j = await r.json();
    if (j.role !== 'admin') { showStatus('Brak roli admin (sprawd≈∫ nick/has≈Ço).'); return; }
    token = j.token;
  }catch(e){
    showStatus('Join error: '+e.message); return;
  }
  showStatus('Zalogowano jako admin.');
  saveCreds();

  // WS
  showStatus('≈ÅƒÖczenie (WS)‚Ä¶');
  try{ ws = new WebSocket(WS_URL + '?token=' + encodeURIComponent(token)); }
  catch(e){ showStatus('WS init error: '+e.message); return; }

  ws.onopen  = ()=>{ showStatus('WS po≈ÇƒÖczone.'); $('controls').style.display='block'; appendWsLog('WS OPEN'); };
  ws.onclose = ()=>{ showStatus('WS roz≈ÇƒÖczone.'); setPresence(0,false); appendWsLog('WS CLOSE'); };
  ws.onerror = ()=>{ showStatus('WS b≈ÇƒÖd.'); appendWsLog('WS ERROR'); };
  ws.onmessage = (ev)=>{
    let m; try{ m=JSON.parse(ev.data) }catch{ return; }
    if(m.type==='hello' || m.type==='presence'){ setPresence(m.occupants ?? 1, true); appendWsLog(`${m.type.toUpperCase()} occupants=${m.occupants ?? 1}`); return; }
    if(m.type==='message'){ const who=(m.user?.name||'user')+' ('+(m.user?.id||'-')+')'; appendWsLog(`MSG id=${m.id} by=${who} | ${m.text}`); injectLastButtons(m); return; }
    if(m.type==='reaction'){ appendWsLog(`REACTION id=${m.id} emoji=${m.emoji} delta=${m.delta}`); injectLastButtons(m); return; }
    if(m.type==='moderate'){ appendWsLog(`MOD action=${m.action} id=${m.id||''} user=${m.userId||''} minutes=${m.minutes||''}`); injectLastButtons(m); return; }
    if(m.type==='announce'){ appendWsLog(`ANNOUNCE "${(m.text||'').slice(0,120)}"`); return; }
  };

  // listy pokoi/u≈ºytkownik√≥w
  selectedRoom = room;
  $('usersRoom').textContent = selectedRoom;
  await refreshRooms();
  await refreshUsers();
  setupAutoAudit(); setupAutoRooms();
};

/* Szybkie kopiowanie ID z ostatniego zdarzenia */
function injectLastButtons(m){
  const toolbarId='lastIds';
  let bar=document.getElementById(toolbarId);
  if(!bar){ bar=document.createElement('div'); bar.id=toolbarId; bar.className='d-flex gap-2 align-items-center my-2'; wsLogEl.parentElement.insertBefore(bar, wsLogEl); }
  bar.innerHTML='';
  if(m.user?.id){ const b=document.createElement('button'); b.className='btn btn-outline-secondary btn-xxs'; b.textContent='Kopiuj userId'; b.onclick=()=>copyToClipboard(m.user.id); bar.appendChild(b); $('userId').value=m.user.id; }
  if(m.id){ const b=document.createElement('button'); b.className='btn btn-outline-secondary btn-xxs'; b.textContent='Kopiuj messageId'; b.onclick=()=>copyToClipboard(m.id); bar.appendChild(b); $('msgId').value=m.id; }
}

/* Wysy≈Çka admin-komend przez WS */
function sendAdmin(obj){ if (ws?.readyState===1) ws.send(JSON.stringify(Object.assign({type:'admin'}, obj))); }

$('announceBtn').onclick = ()=>{ const text=$('announceText').value.trim(); if(text) sendAdmin({ action:'announce', text }); };
$('slowBtn').onclick     = ()=>{ const v=$('slowSelect').value; sendAdmin({ action:'slow', value:v }); };
$('clearBtn').onclick    = ()=> sendAdmin({ action:'clear' });

$('timeoutBtn').onclick  = ()=>{ const userId=$('userId').value.trim(); const minutes=Math.max(1, parseInt($('minutes').value||'5',10)); if(userId) sendAdmin({ action:'timeout', userId, minutes }); };
$('banBtn').onclick      = ()=>{ const userId=$('userId').value.trim(); if(userId) sendAdmin({ action:'ban', userId }); };
$('purgeBtn').onclick    = ()=>{ const userId=$('userId').value.trim(); if(userId) sendAdmin({ action:'purge', userId }); };
$('deleteBtn').onclick   = ()=>{ const id=$('msgId').value.trim(); if(id) sendAdmin({ action:'delete', id }); };

/* Audyt (REST) */
async function refreshAudit(){
  if (!token) return;
  const url = API_AUDIT + '?room=' + encodeURIComponent(selectedRoom || room) + '&limit=300';
  try{
    const r = await fetch(url, { headers: { 'Authorization': 'Bearer '+token } });
    if (!r.ok) { $('auditLog').textContent = 'B≈ÇƒÖd: HTTP '+r.status; return; }
    const j = await r.json();
    const lines = (j.items||[]).map(x=>{
      const t=new Date(x.ts||Date.now()).toISOString().replace('T',' ').slice(0,19);
      const who=(x.name||x.by||'-');
      const parts=[`${t}`, who.padEnd(12,' '), x.action, x.userId?`user=${x.userId}`:'', x.id?`id=${x.id}`:'', (x.minutes!=null)?`minutes=${x.minutes}`:'', (x.value!=null)?`value=${x.value}`:'', x.text?`| ${x.text}`:''].filter(Boolean);
      return parts.join('  ');
    });
    $('auditLog').textContent = lines.join('\n') || '(pusto)';
    $('auditLog').scrollTop = $('auditLog').scrollHeight;
  }catch(e){ $('auditLog').textContent = 'B≈ÇƒÖd: '+e.message; }
}
$('refreshAudit').onclick = refreshAudit;
$('autoAudit').onchange = setupAutoAudit;
$('clearWsLog').onclick = ()=> wsLogEl.textContent='(pusto)';
function setupAutoAudit(){ if(auditTimer){clearInterval(auditTimer);auditTimer=null;} if($('autoAudit').checked){ auditTimer=setInterval(refreshAudit, 10000); } }

/* Pobieranie CSV (z log√≥w serwera) */
$('downloadCsv').onclick = async ()=>{
  if (!token) { alert('Najpierw po≈ÇƒÖcz jako admin.'); return; }
  const rname = selectedRoom || room || '';
  if (!rname) { alert('Brak wybranego pokoju.'); return; }
  try{
    const url = API_LOGCSV + '?room=' + encodeURIComponent(rname);
    const r = await fetch(url, { headers: { 'Authorization': 'Bearer '+token } });
    if(!r.ok){
      let msg = 'B≈ÇƒÖd: HTTP ' + r.status;
      try { const j = await r.json(); if (j?.error) msg += ' ('+j.error+')'; } catch {}
      alert(msg); return;
    }
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `chat-${rname}.csv`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
  }catch(e){
    alert('B≈ÇƒÖd pobierania CSV: ' + (e?.message || e));
  }
};

/* Pokoje (REST) */
$('refreshRooms').onclick = refreshRooms;
$('autoRooms').onchange   = setupAutoRooms;

let auditTimer=null, roomsTimer=null;
let selectedRoom=null;

function setupAutoRooms(){ if(roomsTimer){clearInterval(roomsTimer);roomsTimer=null;} if($('autoRooms').checked){ roomsTimer=setInterval(refreshRooms, 15000); } }

async function refreshRooms(){
  if(!token) return;
  const info=$('roomsInfo'); const tbody=$('roomsTbody');
  info.textContent=''; tbody.innerHTML='';
  try{
    const r = await fetch(API_ROOMS, { headers: { 'Authorization':'Bearer '+token } });
    if(!r.ok){ info.textContent = 'B≈ÇƒÖd: HTTP '+r.status+' (czy endpoint /chat/api/rooms jest wdro≈ºony?)'; return; }
    const j = await r.json();
    const rooms = (j.rooms||[]).sort((a,b)=> (b.occupants||0)-(a.occupants||0));
    if(!rooms.length){ info.textContent='Brak aktywnych pokoi.'; return; }
    rooms.forEach(rm=>{
      const tr=document.createElement('tr'); tr.className='room-row'+(rm.name===selectedRoom?' active':'');
      tr.innerHTML = `
        <td title="${fmtTs(rm.sinceTs)}">${rm.name}</td>
        <td>${rm.occupants??0}</td>
        <td>${rm.slow||'off'}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary btn-xxs" data-act="select">Wejd≈∫</button>
            <button class="btn btn-outline-secondary btn-xxs" data-act="slow"  title="Ustaw slow na 10s">10s</button>
            <button class="btn btn-outline-danger btn-xxs"    data-act="clear">Clear</button>
          </div>
        </td>`;
      tr.querySelector('[data-act="select"]').onclick = async ()=>{ selectedRoom=rm.name; $('usersRoom').textContent=selectedRoom; await refreshUsers(); refreshAudit(); document.querySelectorAll('.room-row').forEach(n=>n.classList.remove('active')); tr.classList.add('active'); };
      tr.querySelector('[data-act="slow"]').onclick   = ()=>{ if(selectedRoom!==rm.name) selectedRoom=rm.name; sendAdmin({ action:'slow', value:'10s', room: rm.name }); };
      tr.querySelector('[data-act="clear"]').onclick  = ()=> sendAdmin({ action:'clear', room: rm.name });
      tbody.appendChild(tr);
    });
  }catch(e){ info.textContent='B≈ÇƒÖd: '+e.message; }
}

/* U≈ºytkownicy (REST) */
$('userSearch').addEventListener('input', ()=> filterUsers());
function filterUsers(){
  const q=$('userSearch').value.trim().toLowerCase();
  document.querySelectorAll('#usersTbody tr').forEach(tr=>{
    const s = (tr.dataset.name||'')+' '+(tr.dataset.id||'');
    tr.style.display = s.includes(q)? '' : 'none';
  });
}
$('refreshUsers').onclick = refreshUsers;

async function refreshUsers(){
  if(!token || !selectedRoom){ $('usersInfo').textContent='Wybierz pok√≥j powy≈ºej.'; $('usersTbody').innerHTML=''; return; }
  const info=$('usersInfo'); const tbody=$('usersTbody'); info.textContent=''; tbody.innerHTML='';
  try{
    const r = await fetch(API_USERS(selectedRoom), { headers: { 'Authorization': 'Bearer '+token } });
    if(!r.ok){ info.textContent='B≈ÇƒÖd: HTTP '+r.status+' (czy endpoint /chat/api/rooms/:room/users jest wdro≈ºony?)'; return; }
    const j = await r.json();
    const users = (j.users||[]).sort((a,b)=> (b.msg||0)-(a.msg||0));
    if(!users.length){ info.textContent='W pokoju brak u≈ºytkownik√≥w.'; return; }
    users.forEach(u=>{
      const tr=document.createElement('tr');
      tr.dataset.name=(u.name||'').toLowerCase(); tr.dataset.id=u.id||'';
      tr.innerHTML=`
        <td title="od: ${fmtTs(u.sinceTs)}">${u.name||'‚Äî'}</td>
        <td><code style="font-size:.85em">${(u.id||'').slice(0,10)}‚Ä¶</code></td>
        <td title="ostatnio: ${fmtTs(u.lastTs)}">${u.msg??0}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary btn-xxs" data-act="copy">Kopiuj</button>
            <button class="btn btn-outline-warning btn-xxs" data-act="t5">T:5</button>
            <button class="btn btn-outline-danger btn-xxs"    data-act="ban">Ban</button>
            <button class="btn btn-outline-danger btn-xxs"    data-act="purge">Purge</button>
          </div>
        </td>`;
      tr.querySelector('[data-act="copy"]').onclick = ()=>{ $('userId').value=u.id; copyToClipboard(u.id); };
      tr.querySelector('[data-act="t5"]').onclick   = ()=> sendAdmin({ action:'timeout', userId:u.id, minutes:5, room: selectedRoom });
      tr.querySelector('[data-act="ban"]').onclick  = ()=> sendAdmin({ action:'ban', userId:u.id, room: selectedRoom });
      tr.querySelector('[data-act="purge"]').onclick= ()=> sendAdmin({ action:'purge', userId:u.id, room: selectedRoom });
      tbody.appendChild(tr);
    });
    filterUsers();
  }catch(e){ info.textContent='B≈ÇƒÖd: '+e.message; }
}
</script>
</body>
</html>
